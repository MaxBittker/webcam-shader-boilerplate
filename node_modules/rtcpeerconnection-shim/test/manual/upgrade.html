<!DOCTYPE html>
<html>
  <head>
    <title>Mocha Tests</title>
  </head>
  <body>
    <button id="upgrade" onclick="upgrade()">upgrade</button>
    <br/>
    <video id="localVideo" autoplay muted style="width:360px"></video>
    <video id="remoteVideo" autoplay volume=0.1 style="width:360px"></video>
  </body>
  <script>
function negotiate() {
    return pc1.createOffer()
        .then(offer => {
            //console.log('offer', offer.sdp);
            return pc2.setRemoteDescription(offer);
        })
        .then(_ => {
            return pc1.setLocalDescription(pc2.remoteDescription);
        })
        .then(_ => {
            return pc2.createAnswer();
        })
        .then(answer => {
            //console.log('answer', answer.sdp);
            return pc1.setRemoteDescription(answer);
        })
        .then(_ => {
            //console.log('pc sld');
            return pc2.setLocalDescription(pc1.remoteDescription);
        })
        .catch(e => {
            console.error(e);
        });
}

function upgrade() {
    navigator.mediaDevices.getUserMedia({video: true})
    .then(stream => {
        const videoTrack = stream.getVideoTracks()[0];
        const oldStream = document.getElementById('localVideo').srcObject;
        oldStream.addTrack(videoTrack);
        document.getElementById('localVideo').srcObject = oldStream;
        pc1.addTrack(videoTrack, oldStream);
        return negotiate();
    })
}

      
var pc1 = new RTCPeerConnection();
var pc2 = new RTCPeerConnection();

pc1.onicecandidate = (e) => {
    //console.log('1->2', e.candidate ? e.candidate.candidate : 'null');
    pc2.addIceCandidate(e.candidate);
}
pc2.onicecandidate = (e) => {
    //console.log('2->1', e.candidate ? e.candidate.candidate : 'null');
    pc1.addIceCandidate(e.candidate);
}
pc2.ontrack = (e) => {
    console.log('addTrack', e.track.kind, e.streams[0].id, e.track.id);
    var remoteVideo = document.getElementById('remoteVideo');
    if (!remoteVideo.srcObject) {
        remoteVideo.srcObject = e.streams[0];
    } else {
        remoteVideo.srcObject = null;
        remoteVideo.srcObject = e.streams[0];
    }
}

navigator.mediaDevices.getUserMedia({audio: true})
.then((stream) => {
    console.log('got stream', stream, stream.getTracks());
    console.log('localVideo', document.getElementById('localVideo'));
    document.getElementById('localVideo').srcObject = stream;
    window.localStream = stream;
    pc1.addTrack(stream.getAudioTracks()[0], stream);
    return negotiate();
})
.catch(e => {
    console.error(e);
});
  </script>
</html>
